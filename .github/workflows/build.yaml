name: Build iOS App

on:
  push:
    branches:
      - main_future
  pull_request:
    branches:
      - main_future
  workflow_dispatch:

jobs:
  build_ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'
          cache: true

      - name: Clean Flutter project
        run: flutter clean

      - name: Upgrade Flutter packages
        run: flutter pub upgrade

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Create or overwrite Podfile
        run: |
          cd ios
          echo "platform :ios, '16.0'" > Podfile
          echo "use_frameworks!" >> Podfile
          echo "use_modular_headers!" >> Podfile
          echo "target 'Runner' do" >> Podfile
          echo "  install_all_flutter_pods(File.dirname(File.realpath(__FILE__)))" >> Podfile
          echo "end" >> Podfile
          echo "post_install do |installer|" >> Podfile
          echo "  installer.pods_project.targets.each do |target|" >> Podfile
          echo "    target.build_configurations.each do |config|" >> Podfile
          echo "      config.build_settings['ENABLE_BITCODE'] = 'NO'" >> Podfile
          echo "      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '16.0'" >> Podfile
          echo "    end" >> Podfile
          echo "  end" >> Podfile
          echo "end" >> Podfile

      - name: Update CocoaPods repository
        run: |
          cd ios
          pod repo update

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install

      - name: Build iOS
        run: flutter build ios --release --no-codesign

      - name: Create IPA
        run: |
          mkdir -p build/ios/ipa
          xcodebuild -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -sdk iphoneos \
            -configuration Release \
            -archivePath build/ios/archive/MyApp.xcarchive \
            archive
          xcodebuild -exportArchive \
            -archivePath build/ios/archive/MyApp.xcarchive \
            -exportPath build/ios/ipa \
            -exportOptionsPlist <(echo '{ "method": "development", "signingStyle": "manual", "teamID": "", "compileBitcode": false, "destination": "export" }') \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Verify IPA path
        run: |
          ls -l build/ios/ipa
          find build/ios/ipa -name "*.ipa"

      - name: Upload IPA
        uses: actions/upload-artifact@v3
        with:
          name: unsigned-ipa
          path: build/ios/ipa/*.ipa
